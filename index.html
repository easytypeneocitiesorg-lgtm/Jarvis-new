<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Jarvis</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body {
    background: black;
    color: white;
    font-family: monospace;
    padding: 10px;
  }
  button {
    background: #111;
    color: white;
    border: 1px solid #444;
    padding: 10px;
    margin-bottom: 10px;
  }
  #log {
    white-space: pre-wrap;
    font-size: 14px;
  }
  .user { color: #7dd3fc; }
  .jarvis { color: #a7f3d0; }
</style>
</head>
<body>

<h2>Jarvis</h2>
<button id="start">Start Jarvis</button>
<div id="log"></div>

<script>
/* =====================
   STATE
===================== */
let jarvisAwake = false;
let speaking = false;
let voicesLoaded = false;

const WAKE_WORD = "hey jarvis";

let memory = [{
  role: "system",
  content: "You are Jarvis, a calm, intelligent male AI assistant. Speak clearly and concisely."
}];

/* =====================
   UI
===================== */
const log = document.getElementById("log");
function addLog(text, cls) {
  const div = document.createElement("div");
  div.className = cls;
  div.textContent = text;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

/* =====================
   VOICE LOADING FIX
===================== */
speechSynthesis.onvoiceschanged = () => {
  voicesLoaded = true;
};

/* =====================
   SPEECH TO TEXT
===================== */
const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

const recognition = new SpeechRecognition();
recognition.continuous = true;
recognition.lang = "en-US";

recognition.onresult = async (event) => {
  if (speaking) return;

  const transcript =
    event.results[event.results.length - 1][0].transcript
      .toLowerCase()
      .trim();

  // Wake word (only once)
  if (!jarvisAwake) {
    if (transcript.includes(WAKE_WORD)) {
      jarvisAwake = true;
      addLog("Jarvis online.", "jarvis");
      speak("I'm online.");
    }
    return;
  }

  // Sleep command
  if (transcript.includes("stop listening")) {
    jarvisAwake = false;
    addLog("Jarvis sleeping.", "jarvis");
    speak("Going offline.");
    return;
  }

  addLog("You: " + transcript, "user");
  memory.push({ role: "user", content: transcript });
  await talkToJarvis();
};

recognition.onend = () => recognition.start();
recognition.onerror = () => recognition.start();

/* =====================
   OPENROUTER
===================== */
async function talkToJarvis() {
  speaking = true;

  const res = await fetch("/api/jarvis", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ messages: memory })
  });

  const data = await res.json();
  const reply = data.reply;

  memory.push({ role: "assistant", content: reply });
  addLog("Jarvis: " + reply, "jarvis");

  await speak(reply);
  speaking = false;
}

/* =====================
   TEXT TO SPEECH (FIXED)
===================== */
function speak(text) {
  return new Promise((resolve) => {
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "en-US";
    utter.rate = 0.95;
    utter.pitch = 0.8;

    const voices = speechSynthesis.getVoices();
    const male = voices.find(v =>
      v.name.includes("Alex") ||
      v.name.includes("Daniel") ||
      v.name.toLowerCase().includes("male")
    );

    if (male) utter.voice = male;

    utter.onend = resolve;
    speechSynthesis.speak(utter);
  });
}

/* =====================
   START BUTTON
===================== */
document.getElementById("start").onclick = () => {
  recognition.start();
  speak("Jarvis initialized.");
  document.getElementById("start").disabled = true;
};
</script>

</body>
</html>

